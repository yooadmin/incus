name: Tests (Alpine)
on:
  push:
    branches:
      - main
      - stable-*
  pull_request:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-alpine-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-tests:
    name: Code (Alpine)
    runs-on: ubuntu-latest  # 若有Alpine runner可替换，此处用Ubuntu模拟容器环境
    container:
      image: alpine:edge
    strategy:
      fail-fast: false
      matrix:
        go:
          - oldstable
          - stable
          - tip
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          apk update
          apk add --no-cache \
            acl-dev \
            autoconf \
            automake \
            bash \
            curl \
            eudev-dev \
            gettext \
            gettext-dev \
            git \
            go \
            intltool \
            libcap-dev \
            libcowsql-dev \
            liblxc-dev \
            libseccomp-dev \
            libselinux-dev \
            libsqlite3-dev \
            libtool \
            linux-headers \
            lz4-dev \
            make \
            pkgconf \
            py3-pipx \
            shellcheck \
            tcl-dev \
            xz

          # 安装Python工具
          pipx install codespell flake8

      - name: Install Go (${{ matrix.go }})
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go }}
        if: matrix.go != 'tip'

      - name: Install Go (tip)
        run: |
          go install golang.org/dl/gotip@latest
          gotip download
          echo "PATH=$HOME/go/bin:$HOME/sdk/gotip/bin:$PATH" >> $GITHUB_ENV
        if: matrix.go == 'tip'

      - name: Fix permissions
        run: |
          chown -R root:root .

      - name: Check Go modules
        run: |
          go mod tidy

      - name: Download dependencies
        run: |
          go mod download

      - name: Build Incus
        env:
          CGO_CFLAGS: "-I/usr/include"
          CGO_LDFLAGS: "-L/usr/lib -lintl"
          CGO_LDFLAGS_ALLOW: "(-Wl,-wrap,pthread_create)|(-Wl,-z,now)"
        run: |
          make

      - name: Static analysis
        env:
          GITHUB_BEFORE: ${{ github.event.before }}
        run: |
          make static-analysis

      - name: Unit tests
        env:
          CGO_CFLAGS: "-I/usr/include"
          CGO_LDFLAGS: "-L/usr/lib -lintl"
          CGO_LDFLAGS_ALLOW: "(-Wl,-wrap,pthread_create)|(-Wl,-z,now)"
        run: |
          go test ./...

  system-tests:
    name: System (Alpine)
    runs-on: ubuntu-latest  # 若有Alpine runner可替换
    container:
      image: alpine:edge
      privileged: true  # 系统测试需要特权模式
    strategy:
      fail-fast: false
      matrix:
        go:
          - stable
        suite:
          - standalone_core
          - standalone_container
          - standalone_network
        backend:
          - dir
          - btrfs
    steps:
      - name: Performance tuning
        run: |
          # 优化ext4挂载参数
          for fs in $(findmnt --noheading --type ext4 --list --uniq | awk '{print $1}'); do
            mount -o remount,noatime,barrier=0,commit=6000 "${fs}" || true
          done

      - name: Checkout
        uses: actions/checkout@v6

      - name: Install system dependencies
        run: |
          apk update
          apk add --no-cache \
            acl \
            attr \
            apparmor \
            bsdextrautils \
            btrfs-progs \
            busybox-static \
            curl \
            dnsmasq \
            dosfstools \
            e2fsprogs \
            gettext \
            git \
            go \
            iproute2 \
            iptables \
            jq \
            lxc-utils \
            lvm2 \
            make \
            nftables \
            openssl \
            pkgconf \
            rsync \
            socat \
            sqlite3 \
            squashfs-tools \
            tar \
            tcl \
            thin-provisioning-tools \
            xfsprogs \
            xz \
            zfs

          # 安装minio
          curl -sSfL https://dl.min.io/server/minio/release/linux-$(uname -m)/archive/minio_20240116160738.0.0_$(uname -m).tar.gz | tar -zxf - -C /usr/local/bin
          chmod +x /usr/local/bin/minio

          # 安装OpenFGA
          mkdir -p "$(go env GOPATH)/bin"
          curl -sSfL https://api.github.com/repos/openfga/openfga/releases/latest | jq -r ".assets[] | .browser_download_url | select(test(\"_linux_$(uname -m).tar.gz\"))" | xargs -I {} curl -sSfL {} -o openfga.tar.gz
          tar -xzf openfga.tar.gz -C "$(go env GOPATH)/bin"
          curl -sSfL https://api.github.com/repos/openfga/cli/releases/latest | jq -r ".assets[] | .browser_download_url | select(test(\"_linux_$(uname -m).tar.gz\"))" | xargs -I {} curl -sSfL {} -o fga.tar.gz
          tar -xzf fga.tar.gz -C "$(go env GOPATH)/bin"

      - name: Install Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go }}

      - name: Setup storage backend (${{ matrix.backend }})
        run: |
          if [ "${{ matrix.backend }}" = "btrfs" ]; then
            mkfs.btrfs -f /dev/loop0
            mkdir -p /var/lib/incus/storage
            mount /dev/loop0 /var/lib/incus/storage
          elif [ "${{ matrix.backend }}" = "zfs" ]; then
            zpool create incus /dev/loop0
          fi

      - name: Build Incus
        env:
          CGO_CFLAGS: "-I/usr/include"
          CGO_LDFLAGS: "-L/usr/lib -lintl"
          CGO_LDFLAGS_ALLOW: "(-Wl,-wrap,pthread_create)|(-Wl,-z,now)"
        run: |
          make

      - name: Configure subuid/subgid
        run: |
          echo "root:1000000:1000000000" | tee /etc/subuid /etc/subgid

      - name: Run system tests (${{ matrix.suite }}, ${{ matrix.backend }})
        env:
          INCUS_BACKEND: ${{ matrix.backend }}
          INCUS_VERBOSE: "1"
          INCUS_TMPFS: "1"
          CGO_LDFLAGS_ALLOW: "(-Wl,-wrap,pthread_create)|(-Wl,-z,now)"
        run: |
          cd test
          ./main.sh ${{ matrix.suite }}

  client-tests:
    name: Client (Alpine)
    runs-on: ubuntu-latest
    container:
      image: alpine:edge
    strategy:
      matrix:
        go:
          - stable
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          apk add --no-cache go

      - name: Install Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go }}

      - name: Run client tests
        env:
          CGO_ENABLED: 0
        run: |
          go test -v ./client/...
          go test -v ./cmd/incus/...
