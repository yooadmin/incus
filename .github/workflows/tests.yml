name: Tests on Alpine
on:
  push:
    branches:
      - main
      - stable-*
  pull_request:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  alpine-tests:
    name: Alpine Functional Tests
    runs-on: ubuntu-24.04  # 可替换为支持 Alpine 的 runner
    container:
      image: alpine:edge
      options: --privileged  # 修正 privileged 语法为 Docker 选项
    strategy:
      fail-fast: false
      matrix:
        backend:
          - dir
          - btrfs
          - lvm
          - zfs

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Update Alpine packages
        run: |
          apk update && apk upgrade

      - name: Install build dependencies
        run: |
          apk add --no-cache \
            git acl-dev autoconf automake eudev-dev gettext-dev go intltool \
            libcap-dev libtool libuv-dev linux-headers lz4-dev tcl-dev \
            sqlite-dev lxc-dev make xz gcc musl-dev 

      - name: Install runtime dependencies
        run: |
          apk add --no-cache \
            acl attr ca-certificates dbus dnsmasq lxc libintl \
            iproute2 iptables netcat-openbsd rsync squashfs-tools shadow-uidmap git \
            tar xz

      - name: Install VM dependencies (if needed)
        run: |
          apk add --no-cache \
            qemu-system-x86_64 qemu-chardev-spice qemu-hw-usb-redirect \
            qemu-hw-display-virtio-vga qemu-img qemu-ui-spice-core ovmf git \
            sgdisk util-linux-misc virtiofsd

      - name: Fix Go environment
        run: |
          export GOPATH=$HOME/go
          export PATH=$GOPATH/bin:/usr/local/go/bin:$PATH
          echo "GOPATH=$GOPATH" >> $GITHUB_ENV
          echo "PATH=$PATH" >> $GITHUB_ENV

      - name: Build Incus
        run: |
            # 检查是否存在 clean 目标，存在则执行，否则跳过
            if grep -q '^clean:' Makefile; then
            make clean
            fi
            make
            shell: sh -e {0}

      - name: Run static analysis
        run: |
          make static-analysis

      - name: Run unit tests
        run: |
          make test-go

      - name: Setup Incus daemon
        run: |
          rc-update add incusd
          rc-service incusd start
          incus admin init --auto

      - name: Run functional tests
        run: |
          incus launch images:alpine/edge test-container
          incus exec test-container -- apk update
          incus delete test-container --force
