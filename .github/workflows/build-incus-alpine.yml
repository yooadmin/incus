name: Build Incus on Alpine (Fixed Dependencies)

on:
  push:
    branches: [ main, stable-* ]
  pull_request:
    branches: [ main, stable-* ]

permissions:
  contents: read
  packages: write

jobs:
  build-alpine:
    name: Build Incus on Alpine Edge
    runs-on: ubuntu-latest
    container:
      image: alpine:edge
      options: --privileged
    env:
      # 强制指定完整PATH，解决命令找不到问题
      PATH: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

    steps:
      - name: Emergency fix for Alpine PATH & repo
        run: |
          # 强制重置PATH并更新系统核心库
          export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
          # 替换为国内镜像加速（可选，删除不影响）
          sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories || true
          # 先安装最基础的工具链（解决autoconf等命令找不到）
          apk add --no-cache --force-refresh \
            bash coreutils findutils grep sed gawk make gcc musl-dev \
            autoconf automake libtool pkgconfig

      - name: Install full build dependencies (Official List)
        run: |
          # 严格按Incus官方文档安装所有依赖
          apk add --no-cache \
            # 基础编译工具（补全所有缺失的核心工具）
            acl-dev autoconf automake eudev-dev gettext-dev go intltool \
            libcap-dev libtool libuv-dev linux-headers lz4-dev tcl-dev \
            sqlite-dev lxc-dev make xz \
            # 运行时依赖
            acl attr ca-certificates cgmanager dbus dnsmasq lxc iproute2 \
            iptables netcat-openbsd rsync squashfs-tools shadow-uidmap tar \
            # 可选：虚拟机支持（不需要可删除）
            qemu-system-x86_64 qemu-img virtiofsd ovmf

      - name: Verify critical tools exist
        run: |
          # 检查核心编译工具是否真的安装成功
          command -v autoconf || (echo "autoconf missing!" && exit 1)
          command -v automake || (echo "automake missing!" && exit 1)
          command -v go || (echo "go missing!" && exit 1)
          command -v make || (echo "make missing!" && exit 1)

      - name: Checkout Incus source code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure build environment (Official)
        run: |
          # 官方要求的CGO环境变量
          export CGO_CFLAGS="-I/usr/include -I$(go env GOPATH)/deps/cowsql/include -I$(go env GOPATH)/deps/raft/include"
          export CGO_LDFLAGS="-L/usr/lib -L$(go env GOPATH)/deps/cowsql/.libs -L$(go env GOPATH)/deps/raft/.libs -lintl"
          export LD_LIBRARY_PATH="/usr/lib:$(go env GOPATH)/deps/cowsql/.libs:$(go env GOPATH)/deps/raft/.libs"
          export CGO_LDFLAGS_ALLOW="(-Wl,-wrap,pthread_create)|(-Wl,-z,now)"
          # 写入环境变量供后续步骤使用
          echo "CGO_CFLAGS=${CGO_CFLAGS}" >> $GITHUB_ENV
          echo "CGO_LDFLAGS=${CGO_LDFLAGS}" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=${LD_LIBRARY_PATH}" >> $GITHUB_ENV
          echo "CGO_LDFLAGS_ALLOW=${CGO_LDFLAGS_ALLOW}" >> $GITHUB_ENV

      - name: Build dependencies (make deps)
        run: make deps

      - name: Compile Incus
        run: make

      - name: Validate build output
        run: |
          # 检查二进制文件是否生成
          if [ ! -f bin/incus ] || [ ! -f bin/incusd ] || [ ! -f bin/incus-agent ]; then
            echo "Compilation failed: binaries missing!"
            ls -l bin/ || true
            exit 1
          fi
          # 验证版本
          bin/incus --version || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v5
        with:
          name: incus-alpine-edge-${{ github.sha }}
          path: |
            bin/incus
            bin/incusd
            bin/incus-agent
          retention-days: 14
