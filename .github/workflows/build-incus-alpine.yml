name: Build Incus on Alpine (Official Dependencies)

on:
  push:
    branches: [ main, stable-* ]
  pull_request:
    branches: [ main, stable-* ]

permissions:
  contents: read
  packages: write

jobs:
  build-alpine:
    name: Build Incus on Alpine Edge
    runs-on: ubuntu-latest
    container:
      image: alpine:edge
      options: --privileged  # 特权模式支持cowsql/raft编译

    steps:
      - name: Fix Alpine repository mirror (optional)
        run: |
          sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories || true

      - name: Update system and install core dependencies
        run: |
          apk update && apk upgrade --no-cache
          # 严格按照官方文档安装编译依赖
          apk add --no-cache \
            # 基础编译工具
            autoconf automake libtool make pkg-config intltool gettext-dev \
            # Go环境
            go \
            # 系统库依赖（官方指定）
            acl-dev eudev-dev libcap-dev libuv-dev linux-headers lz4-dev \
            tcl-dev sqlite-dev lxc-dev xz \
            # 运行时基础依赖
            acl attr ca-certificates dbus dnsmasq lxc iproute2 iptables \
            netcat-openbsd rsync squashfs-tools shadow-uidmap tar \
            # 可选：虚拟机支持（如需编译虚拟机功能）
            qemu-system-x86_64 qemu-img virtiofsd ovmf

      - name: Checkout Incus source code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # 完整克隆历史用于版本检测

      - name: Configure build environment (官方指定的环境变量)
        run: |
          # 设置Go模块代理（加速依赖下载）
          echo "GOPROXY=https://goproxy.cn,direct" >> $GITHUB_ENV
          # 官方要求的CGO配置
          echo "CGO_CFLAGS=-I/usr/include -I$(go env GOPATH)/deps/cowsql/include -I$(go env GOPATH)/deps/raft/include" >> $GITHUB_ENV
          echo "CGO_LDFLAGS=-L/usr/lib -L$(go env GOPATH)/deps/cowsql/.libs -L$(go env GOPATH)/deps/raft/.libs -lintl" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=/usr/lib:$(go env GOPATH)/deps/cowsql/.libs:$(go env GOPATH)/deps/raft/.libs" >> $GITHUB_ENV
          echo "CGO_LDFLAGS_ALLOW=(-Wl,-wrap,pthread_create)|(-Wl,-z,now)" >> $GITHUB_ENV

      - name: Build cowsql/raft dependencies (官方流程)
        run: |
          make deps

      - name: Compile Incus (官方make流程)
        run: |
          make

      - name: Verify compiled binaries
        run: |
          # 检查二进制文件是否生成
          ls -l bin/incus bin/incusd bin/incus-agent
          # 验证二进制文件可执行
          bin/incus --version || true
          bin/incusd --version || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: incus-alpine-edge-${{ github.sha }}
          path: |
            bin/incus
            bin/incusd
            bin/incus-agent
          retention-days: 14  # 延长产物保存时间
