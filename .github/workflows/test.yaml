name: Tests (Alpine)
on:
  push:
    branches:
      - main
      - stable-*
  pull_request:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  alpine-tests:
    name: Alpine Linux Tests
    runs-on: ubuntu-24.04  # 使用Ubuntu主机运行Alpine容器
    container:
      image: alpine:latest
      options: --privileged  # 测试需要特权模式（如挂载、网络配置等）

    steps:
      - name: Update Alpine and install base dependencies
        run: |
          apk add acl-dev autoconf automake eudev-dev gettext-dev go intltool libcap-dev libtool libuv-dev linux-headers lz4-dev tcl-dev sqlite-dev lxc-dev make xz

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go environment
        run: |
          echo "GOPATH=$(go env GOPATH)" >> $GITHUB_ENV
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Install Go dependencies
        run: |
          go mod download

      - name: Build Incus
        env:
          CGO_LDFLAGS_ALLOW: "(-Wl,-wrap,pthread_create)|(-Wl,-z,now)"
        run: |
          make

      - name: Run static analysis
        run: |
          make static-analysis

      - name: Run unit tests
        run: |
          go test ./...

      - name: Prepare system tests
        run: |
          # 配置subuid/subgid（用于用户命名空间）
          echo "root:1000000:1000000000" >> /etc/subuid
          echo "root:1000000:1000000000" >> /etc/subgid

          # 启动必要服务
          rc-service dbus start
          rc-service apparmor start

      - name: Run system tests (standalone)
        env:
          INCUS_BACKEND: dir
          INCUS_VERBOSE: 1
          INCUS_TMPFS: 1
        run: |
          cd test
          ./main.sh standalone_core standalone_container
