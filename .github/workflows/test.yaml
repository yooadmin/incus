name: Incus Alpine Build & Test (No Static Analysis)
on:
  push:
    branches: [main, stable-*]
  pull_request:
    branches: [main, stable-*]

permissions:
  contents: read
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  alpine-compile:
    name: Alpine x86_64 Compile
    runs-on: ubuntu-24.04
    container:
      image: alpine:edge
      options: --privileged --security-opt seccomp=unconfined
    steps:
      # Step 1: 安装核心依赖（仅保留编译/测试必需）
      - name: Install Core Dependencies
        run: |
          # 配置Alpine基础仓库
          echo "http://dl-cdn.alpinelinux.org/alpine/edge/main" > /etc/apk/repositories
          echo "http://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
          
          apk update && apk upgrade -y
          apk add --no-cache \
            git make gcc musl-dev pkgconf bash libc6-compat curl \
            gettext gettext-dev libintl \
            acl-dev autoconf automake eudev-dev go intltool libcap-dev \
            libtool libuv-dev linux-headers lz4-dev tcl-dev sqlite-dev lxc-dev xz \
            apparmor btrfs-progs busybox-static dbus dnsmasq iproute2 iptables \
            libseccomp-dev lvm2 nftables rsync squashfs-tools shadow-uidmap \
            tar util-linux-misc zfs

      # Step 2: 检出代码
      - name: Checkout Incus Source
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          path: incus

      # Step 3: 配置Go环境 & 编译参数
      - name: Setup Go & Compile Env
        working-directory: incus
        run: |
          echo "GOPATH=$(go env GOPATH)" >> $GITHUB_ENV
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          # 核心CGO参数（解决libintl/依赖库链接）
          echo "CGO_CFLAGS=-I$(go env GOPATH)/deps/raft/include -I$(go env GOPATH)/deps/cowsql/include -I/usr/include" >> $GITHUB_ENV
          echo "CGO_LDFLAGS=-L$(go env GOPATH)/deps/raft/.libs -L$(go env GOPATH)/deps/cowsql/.libs -L/usr/lib -lintl" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=$(go env GOPATH)/deps/raft/.libs:$(go env GOPATH)/deps/cowsql/.libs:/usr/lib" >> $GITHUB_ENV
          echo "CGO_LDFLAGS_ALLOW=(-Wl,-wrap,pthread_create)|(-Wl,-z,now)" >> $GITHUB_ENV

      # Step 4: 下载Go模块依赖
      - name: Download Go Dependencies
        working-directory: incus
        run: go mod download

      # Step 5: 修复cowsql编译目录缺失
      - name: Fix Cowsql Compile Dir
        run: |
          mkdir -p /usr/local/include
          chmod 755 /usr/local/include

      # Step 6: 安装cowsql/raft依赖
      - name: Install Cowsql/Raft Dependencies
        working-directory: incus
        run: make deps

      # Step 7: 编译Incus（核心步骤）
      - name: Compile Incus
        working-directory: incus
        run: |
          # 解决Git仓库所有权问题
          git config --global --add safe.directory /__w/incus/incus
          # 编译（禁用VCS+传递CGO参数）
          make build \
            GOFLAGS="-buildvcs=false" \
            CGO_CFLAGS="${{ env.CGO_CFLAGS }}" \
            CGO_LDFLAGS="${{ env.CGO_LDFLAGS }}" \
            CGO_LDFLAGS_ALLOW="${{ env.CGO_LDFLAGS_ALLOW }}"
          # 完整构建
          make \
            CGO_CFLAGS="${{ env.CGO_CFLAGS }}" \
            CGO_LDFLAGS="${{ env.CGO_LDFLAGS }}" \
            CGO_LDFLAGS_ALLOW="${{ env.CGO_LDFLAGS_ALLOW }}"

      # Step 8: 单元测试（可选，可删除）
      - name: Unit Tests
        working-directory: incus
        run: |
          go test ./... \
            -buildvcs=false \
            -v \
            CGO_CFLAGS="${{ env.CGO_CFLAGS }}" \
            CGO_LDFLAGS="${{ env.CGO_LDFLAGS }}"

      # Step 9: 系统测试准备
      - name: Prepare System Tests
        working-directory: incus
        run: |
          # 配置用户命名空间
          echo "root:1000000:1000000000" >> /etc/subuid
          echo "root:1000000:1000000000" >> /etc/subgid
          # 启动必要服务
          rc-update add dbus && rc-service dbus start
          rc-update add apparmor && rc-service apparmor start
          mkdir -p /etc/apparmor.d && touch /etc/apparmor.d/tunables/global

      # Step 10: 运行核心系统测试（可选，可删除）
      - name: Run Core System Tests
        working-directory: incus/test
        env:
          INCUS_BACKEND: dir
          INCUS_VERBOSE: 1
          INCUS_TMPFS: 1
          CGO_CFLAGS: "${{ env.CGO_CFLAGS }}"
          CGO_LDFLAGS: "${{ env.CGO_LDFLAGS }}"
          LD_LIBRARY_PATH: "${{ env.LD_LIBRARY_PATH }}"
        run: ./main.sh standalone_core standalone_container

      # Step 11: 上传编译产物（便于下载使用）
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: incus-alpine-x86_64
          path: |
            incus/bin/incus
            incus/bin/incus-agent
            incus/bin/incus-migrate
          retention-days: 7
