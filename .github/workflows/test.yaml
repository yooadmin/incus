name: Incus Alpine Compile Only (No Tests)
on:
  push:
    branches: [main, stable-*]
  pull_request:
    branches: [main, stable-*]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  alpine-compile:
    name: Alpine x86_64 Compile
    runs-on: ubuntu-24.04
    container:
      image: alpine:edge
      options: --privileged

    steps:
      - name: Install Minimal Compile Dependencies
        run: |
          echo "http://dl-cdn.alpinelinux.org/alpine/edge/main" > /etc/apk/repositories
          echo "http://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
          apk update
          apk add --no-cache \
            git make gcc musl-dev pkgconf bash libc6-compat curl \
            gettext gettext-dev libintl \
            acl-dev autoconf automake eudev-dev go intltool libcap-dev \
            libtool libuv-dev linux-headers lz4-dev tcl-dev sqlite-dev lxc-dev xz

      - name: Checkout Incus Source Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          path: incus  # 代码检出到 /__w/incus/incus

      - name: Setup Go Environment & Compile Flags
        working-directory: incus
        run: |
          echo "GOPATH=$(go env GOPATH)" >> $GITHUB_ENV
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          echo "CGO_CFLAGS=-I$(go env GOPATH)/deps/raft/include -I$(go env GOPATH)/deps/cowsql/include -I/usr/include" >> $GITHUB_ENV
          echo "CGO_LDFLAGS=-L$(go env GOPATH)/deps/raft/.libs -L$(go env GOPATH)/deps/cowsql/.libs -L/usr/lib -lintl" >> $GITHUB_ENV
          echo "CGO_LDFLAGS_ALLOW=(-Wl,-wrap,pthread_create)|(-Wl,-z,now)" >> $GITHUB_ENV

      - name: Download Go Module Dependencies
        working-directory: incus
        run: go mod download

      - name: Fix Cowsql Compile Directory
        run: |
          mkdir -p /usr/local/include
          chmod 755 /usr/local/include

      - name: Install Cowsql/Raft Dependencies
        working-directory: incus
        run: make deps

      - name: Compile Incus
        working-directory: incus
        run: |
          git config --global --add safe.directory /__w/incus/incus
          make build \
            GOFLAGS="-buildvcs=false" \
            CGO_CFLAGS="${{ env.CGO_CFLAGS }}" \
            CGO_LDFLAGS="${{ env.CGO_LDFLAGS }}" \
            CGO_LDFLAGS_ALLOW="${{ env.CGO_LDFLAGS_ALLOW }}"
          make \
            CGO_CFLAGS="${{ env.CGO_CFLAGS }}" \
            CGO_LDFLAGS="${{ env.CGO_LDFLAGS }}" \
            CGO_LDFLAGS_ALLOW="${{ env.CGO_LDFLAGS_ALLOW }}"
          
          # 可选：验证编译产物是否存在（便于调试）
          ls -l ./bin/ || echo "Bin directory not found"

      # 核心修复：修正产物上传路径
      - name: Upload Compiled Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: incus-alpine-x86_64
          # 正确路径：代码在incus目录下，编译产物在 ./bin（即 /__w/incus/incus/bin）
          path: |
            incus/bin/incus
            incus/bin/incus-agent
            incus/bin/incus-migrate
          # 兜底：若上面路径仍找不到，用绝对路径（备选方案）
          # path: |
          #   /__w/incus/incus/bin/incus
          #   /__w/incus/incus/bin/incus-agent
          #   /__w/incus/incus/bin/incus-migrate
          retention-days: 7
