name: Incus Alpine Compile Only (No Tests)
on:
  push:
    branches: [main, stable-*]
  pull_request:
    branches: [main, stable-*]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  alpine-compile:
    name: Alpine x86_64 Compile
    runs-on: ubuntu-24.04
    container:
      image: alpine:edge
      options: --privileged

    steps:
      - name: Install Minimal Compile Dependencies
        run: |
          echo "http://dl-cdn.alpinelinux.org/alpine/edge/main" > /etc/apk/repositories
          echo "http://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
          apk update
          apk add --no-cache \
            git make gcc musl-dev pkgconf bash libc6-compat curl \
            gettext gettext-dev libintl \
            acl-dev autoconf automake eudev-dev go intltool libcap-dev \
            libtool libuv-dev linux-headers lz4-dev tcl-dev sqlite-dev lxc-dev xz

      - name: Checkout Incus Source Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          path: incus

      - name: Setup Go Environment & Compile Flags
        working-directory: incus
        run: |
          # 导出GOPATH并写入环境变量
          export GOPATH=$(go env GOPATH)
          echo "GOPATH=${GOPATH}" >> $GITHUB_ENV
          echo "${GOPATH}/bin" >> $GITHUB_PATH
          
          # 核心CGO参数
          echo "CGO_CFLAGS=-I${GOPATH}/deps/raft/include -I${GOPATH}/deps/cowsql/include -I/usr/include" >> $GITHUB_ENV
          echo "CGO_LDFLAGS=-L${GOPATH}/deps/raft/.libs -L${GOPATH}/deps/cowsql/.libs -L/usr/lib -lintl" >> $GITHUB_ENV
          echo "CGO_LDFLAGS_ALLOW=(-Wl,-wrap,pthread_create)|(-Wl,-z,now)" >> $GITHUB_ENV

      - name: Download Go Module Dependencies
        working-directory: incus
        run: go mod download

      - name: Fix Cowsql Compile Directory
        run: |
          mkdir -p /usr/local/include
          chmod 755 /usr/local/include

      - name: Install Cowsql/Raft Dependencies
        working-directory: incus
        run: make deps

      - name: Compile Incus
        working-directory: incus
        run: |
          git config --global --add safe.directory /__w/incus/incus
          make build \
            GOFLAGS="-buildvcs=false" \
            CGO_CFLAGS="${{ env.CGO_CFLAGS }}" \
            CGO_LDFLAGS="${{ env.CGO_LDFLAGS }}" \
            CGO_LDFLAGS_ALLOW="${{ env.CGO_LDFLAGS_ALLOW }}"
          make \
            CGO_CFLAGS="${{ env.CGO_CFLAGS }}" \
            CGO_LDFLAGS="${{ env.CGO_LDFLAGS }}" \
            CGO_LDFLAGS_ALLOW="${{ env.CGO_LDFLAGS_ALLOW }}"
          
          # 验证产物：列出GOPATH/bin下所有文件
          echo "=== All files in GOPATH/bin ==="
          ls -l ${{ env.GOPATH }}/bin/ || echo "GOPATH/bin is empty"
          echo "==============================="

      # 核心修改：上传GOPATH/bin目录下所有文件
      - name: Upload All Compiled Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: incus-alpine-x86_64-all
          # 直接指定GOPATH/bin目录，上传该目录下所有文件
          path: ${{ env.GOPATH }}/bin/
          retention-days: 7
